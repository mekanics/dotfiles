#!/bin/zsh
###
### rename_invoices — rename the invoices for our bookkeeper
###
### Usage:
###   rename_invoices
###
### Options:
###   --dry-run             Does not rename the files
###   -v, --verbose         Log out the renamed files
###   -h, --help            Show this help message and exit"

set -e

help() {
    awk -F'### ' '/^###/ { print $2 }' "$0"
}

while test $# -gt 0; do
    case "$1" in
    "-h" | "--help")
        help
        exit
        ;;
    "--dry-run")
        DRY_RUN=true
        ;;
    "-v" | "--verbose")
        VERBOSE=true
        ;;
    *)
        echo "Invalid option: $1"
        help
        exit
        ;;
    esac
    shift
done

for file in *.pdf; do
    content=$(pdftotext -raw $file -)
    date=$(echo $content | grep -o -E 'Rechnungsdatum [0-9]{2}\.[0-9]{2}\.[0-9]{4}' | grep -oEi '\d.+' | xargs date -jf '%d.%m.%Y' +%y%m%d)
    invoice=$(echo $content | grep -o -E 'Rechnung \d.+' | grep -oEi '\d.+')

    if [ "$VERBOSE" = true -o "$DRY_RUN" = true ]; then
        cmd="${cmd} -print"
        echo "rename \"$file\" -> \"$date $invoice @ KiloKilo GmbH.pdf\""
    fi

    if [ "$DRY_RUN" != true ]; then
        mv "$file" "$date $invoice @ KiloKilo GmbH.pdf"
    fi

done

echo "☑️ done"
